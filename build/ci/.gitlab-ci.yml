include:
- https://tn:qk9kruunqgkx3mqn@pipeline-template.tages.dev/tn/build-kaniko.yml

default:
  tags:
    - tn-697


stages:
# - test
- build
- deploy

build:
  variables:
    DOCKER_FILE_FOLDER: $CI_PROJECT_DIR/build/ci
  extends: .build-kaniko-v1
  script: |
    build
  only:
  - main
  - tags
  - /^story/.*$/

deploy:
  stage: deploy
  image: docker-public.registry.tages.ru/curlimages/curl:7.69.1
  script: |
    curl -X POST \
      -F token=$TOKEN_DEPLOY_TRIGGER \
      -F ref=master \
      -F "variables[PROJECT]=$CI_PROJECT_PATH" \
      -F "variables[BRANCH]=$CI_COMMIT_REF_NAME" \
      https://git.tjump.ru/api/v4/projects/$ID_DEPLOY_PROJECT/trigger/pipeline
  only:
  - main
  - /^release$|^release-upd$/

